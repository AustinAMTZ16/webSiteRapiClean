<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Resumen de Pedido - RapiClean</title>
    <meta name="description"
        content="Lavandería RapiClean Puebla: servicio profesional de lavado, planchado, costura y tintorería. Recolección y entrega. Calidad garantizada.">
    <meta name="keywords"
        content="lavandería en Puebla, lavado de ropa, planchado profesional, tintorería, RapiClean, servicio a domicilio">
    <meta name="robots" content="index, follow">
    <meta name="author" content="RapiClean Puebla">
    <meta name="language" content="es">
    <meta name="theme-color" content="#00aeef">
    <link rel="shortcut icon" href="assets/img/logo-icon/logopequemas.png" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/style.css">

    <!-- DataTables opcional si quieres buscador/paginado -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="assets/js/SesionUser.js"></script>

    <style>
        #paypal-button-wrapper {
            display: flex;
            justify-content: center;
            margin-top: 2rem;
        }

        #paypal-button-container {
            width: 300px;
        }
    </style>
</head>

<body>
    <!-- 0. header Top, Logo, Menú -->
    <header class="top">
        <div class="header-top">
            <div class="container">
                <p>
                    ¿Cotiza tu servicio?
                    <a href="tel:+522211276404">2211276404</a> /
                    <a href="tel:+522211276404">2211276404</a>
                </p>
            </div>
        </div>

        <div class="header-area">
            <div class="container">
                <div class="grid">
                    <div class="logo">
                        <a href="index.html"><img src="assets/img/logo-icon/logo.png" alt="Logo"></a>
                    </div>

                    <div class="main-menu">
                        <ul class="nav-list">
                            <li><a class="nav-link" href="index.html">Inicio</a></li>
                            <li><a class="nav-link" href="#about">Acerca de</a></li>
                            <li><a class="nav-link" href="catalogo.html">Servicios</a></li>
                            <li><a class="nav-link" href="#contacto">Contacto</a></li>
                            <li><a class="nav-link btn-primary" id="Registrarse" href="registro.html" style="
                                                                                                                border-radius: 10px;
                                                                                                                display: inline-block;
                                                                                                                white-space: nowrap;
                                                                                                                vertical-align: middle;
                                                                                                                padding: 10px 20px;
                                                                                                                margin-left: 10px;
                                                                                                            ">Solicita
                                    tu servicio</a>
                            </li>
                            <!-- <li><a class="nav-link btn btn-primary" id="CerrarSesion">Cerrar Sesión</a></li> -->
                            <li><a class="nav-link btn-primary" id="Perfil" href="perfil.html"
                                    style="
                                                                                                                border-radius: 10px;
                                                                                                                display: inline-block;
                                                                                                                white-space: nowrap;
                                                                                                                vertical-align: middle;
                                                                                                                padding: 10px 20px;
                                                                                                                margin-left: 10px;
                                                                                                            ">Perfil</a></li>
                        </ul>
                    </div>

                    <!-- Menú hamburguesa móvil -->
                    <div class="hamburger" onclick="toggleMenu()">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Menú móvil -->
        <div class="mobile-menu" id="mobileMenu">
            <div class="mobile-nav">
                <li><a class="nav-link" href="index.html">Inicio</a></li>
                <li><a class="nav-link" href="#about">Acerca de</a></li>
                <li><a class="nav-link" href="catalogo.html">Servicios</a></li>
                <li><a class="nav-link" href="#contacto">Contacto</a></li>
                <li><a class="nav-link btn-primary" id="Registrarse" href="registro.html" style="
                                                                                                                border-radius: 10px;
                                                                                                                display: inline-block;
                                                                                                                white-space: nowrap;
                                                                                                                vertical-align: middle;
                                                                                                                padding: 10px 20px;
                                                                                                                margin-left: 10px;
                                                                                                            ">Solicita
                        tu servicio</a>
                </li>
                <li><a class="nav-link btn-primary" id="Perfil" href="perfil.html"
                        style="
                                                                                                                border-radius: 10px;
                                                                                                                display: inline-block;
                                                                                                                white-space: nowrap;
                                                                                                                vertical-align: middle;
                                                                                                                padding: 10px 20px;
                                                                                                                margin-left: 10px;
                                                                                                            ">Perfil</a></li>
            </div>
        </div>
    </header>

    <section class="final-cta">
        <div class="container">
            <h2 class="section-title">Resumen de tu Pedido</h2>

            <div id="infoCliente" style="text-align:center; margin-bottom: 1rem; font-size: 1.1rem;">
                <!-- Aquí se mostrará el cliente -->
            </div>


            <table id="tablaPedido" class="display" style="width:100%">
                <thead>
                    <tr>
                        <th>Servicio</th>
                        <th>Cantidad</th>
                        <th>Precio</th>
                        <th>Subtotal</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <h3 style="text-align:center; margin-top:2rem;">Total: $<span id="totalPedido">0.00</span></h3>

            <div style="text-align:center; margin-top:2rem;">
                <h3>Selecciona tu método de pago</h3>
                <select id="metodoPago" style="padding: 1rem; font-size: 1rem; margin-bottom: 1rem;">
                    <option value="Efectivo">Efectivo</option>
                    <option value="PayPal">Tarjeta Credito/Debito</option>
                    <!-- <option value="MercadoPago">Mercado Pago</option> -->
                </select>
                <br />


                <button class="btn btn-primary" id="btnConfirmarPedido" onclick="confirmarPedido()">Realizar
                    Pedido</button>
            </div>

            <p id="respuestaPedido" style="margin-top:1rem; font-weight:bold; text-align:center;"></p>
        </div>
    </section>

    <script>
        // validar al cargar la pagina si hay usuario en localStorage
        document.addEventListener("DOMContentLoaded", () => {
            const usuario = JSON.parse(localStorage.getItem("usuario"));
            if (!usuario) {
                alert("⚠️ Debes iniciar sesión para ver tu carrito.");
                window.location.href = "login.html"; // Redirige al login si no hay usuario
            }
        });
    </script>

    <script>
        let ventaIDGlobal = null;

        let carrito = JSON.parse(localStorage.getItem("carrito")) || [];

        function mostrarCarrito() {
            const tbody = document.querySelector("#tablaPedido tbody");
            tbody.innerHTML = "";

            let total = 0;

            carrito.forEach(servicio => {
                const subtotal = servicio.precio * servicio.cantidad;
                total += subtotal;

                const row = `
                                <tr>
                                <td>${servicio.nombre}</td>
                                <td>${servicio.cantidad}</td>
                                <td>$${servicio.precio.toFixed(2)}</td>
                                <td>$${subtotal.toFixed(2)}</td>
                                </tr>
                            `;
                tbody.innerHTML += row;
            });

            document.getElementById("totalPedido").textContent = total.toFixed(2);
            $('#tablaPedido').DataTable({
                paging: false,
                searching: false,
                info: false,
                destroy: true
            });
        }

        async function confirmarPedido() {
            const total = parseFloat(document.getElementById("totalPedido").textContent);
            const metodo = document.getElementById("metodoPago").value;

            const usuario = JSON.parse(localStorage.getItem("usuario"));
            const clienteID = usuario?.ClienteID || 1;
            const usuarioID = 1; // Este es fijo por ahora, modifícalo si usas sesión de usuario

            const servicios = carrito.map(item => ({
                id: item.id,
                cantidad: item.cantidad,
                precio: item.precio
            }));

            const payload = {
                usuarioID: usuarioID,
                clienteID: parseInt(clienteID),
                metodoPago: metodo,
                servicios: servicios,
                codigoDescuento: "", // opcional
                comentarios: "Pedido realizado desde sitio web"
            };

            const res = await fetch("https://app.rapicleanpuebla.com/index.php?action=registrarVenta", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const result = await res.json();
            ventaIDGlobal = result.data.ventaID; // Asegúrate de que tu backend lo devuelva
            const mensaje = document.getElementById("respuestaPedido");

            if (result.message === "Venta registrada.") {
                mensaje.innerHTML = "🎉 Pedido registrado exitosamente. <br> Realiza tu pago con tu cuenta PayPal o directacmemnte con los datos de tu tarjeta de credito o debito.";
                mensaje.style.color = "green";
                localStorage.removeItem("carrito");

                // Ocultar el botón de Confirmar Pedido
                document.getElementById("btnConfirmarPedido").style.display = "none";


                const botones = {
                    Efectivo: `<a href="catalogo.html" class="btn btn-primary">Volver al Catálogo</a>`,
                    PayPal: `
                                <div id="paypal-button-wrapper">
                                    <div id="paypal-button-container"></div>
                                </div>
                            `,
                    MercadoPago: `<button class="btn btn-primary" onclick="pagarConMercadoPago(${total})">Pagar con Mercado Pago</button>`

                };

                mensaje.innerHTML += "<br><br>" + botones[metodo];

                if (metodo === "PayPal") {
                    setTimeout(() => pagarConPayPal(total), 0);
                }

            } else {
                mensaje.textContent = "❌ Error al registrar pedido: " + (result.message || "Intenta nuevamente.");
                mensaje.style.color = "red";
            }
        }

        mostrarCarrito();


        function mostrarDatosCliente() {
            const infoCliente = document.getElementById("infoCliente");
            const datosUsuario = JSON.parse(localStorage.getItem("usuario"));

            if (datosUsuario) {
                infoCliente.innerHTML = `
                                            <p><strong>Cliente:</strong> ${datosUsuario.Nombre}</p>
                                            <p><strong>Email:</strong> ${datosUsuario.Email}</p>
                                            <p><strong>Puntos:</strong> ${datosUsuario.PuntosRecompensa}</p>
                                        `;
            } else {
                infoCliente.innerHTML = `<p style="color:red;">⚠️ No se encontró información del cliente.</p>`;
            }
        }

        mostrarDatosCliente();

    </script>

    <script
        src="https://www.paypal.com/sdk/js?client-id=AUYzDJQa46w_x43NxYPik8fEcTUXpVFpJn53CNGwbciIgj9vQ9T3aF4WphQ6iwJF3-ZJgQd3IT6HZHyI&currency=MXN&intent=capture&components=buttons&buyer-country=MX">
        </script>
    <script>
        function pagarConPayPal(total) {
            if (!ventaIDGlobal) {
                console.error("❌ No se puede procesar el pago porque ventaIDGlobal está vacío");
                return;
            }

            document.getElementById("paypal-button-container").innerHTML = "";

            paypal.Buttons({
                fundingSource: paypal.FUNDING.CARD, // Solo muestra tarjeta
                style: {
                    layout: 'vertical',
                    color: 'black',
                    shape: 'rect',
                    label: 'pay'
                },

                createOrder: function (data, actions) {
                    return actions.order.create({
                        purchase_units: [{
                            amount: { value: total },
                            custom_id: ventaIDGlobal // Este debe ser un número, asegúrate que no sea "ventaIDGlobal" como string
                        }]
                    });
                },

                onApprove: function (data, actions) {
                    return actions.order.capture().then(async function (details) {
                        const ventaID = details.purchase_units[0].custom_id;
                        const transaccionID = details.id;

                        console.log("✅ Pago exitoso:", {
                            transaccionID,
                            ventaID,
                            payer: details.payer,
                            amount: details.purchase_units[0].amount
                        });

                        // Llamada al endpoint para actualizar estado de la venta
                        try {
                            const res = await fetch("https://app.rapicleanpuebla.com/index.php?action=actualizarEstadoVenta", {
                                method: "PATCH",
                                headers: {
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify({
                                    nuevoEstado: "Pagado",
                                    ventaID: parseInt(ventaID),
                                    RespuestaPagoID: transaccionID
                                })
                            });

                            const resultado = await res.json();
                            console.log("🔁 Resultado de actualización:", resultado);

                            // Mostrar mensaje en el DOM (mejor UX)
                            const mensaje = document.getElementById("respuestaPedido");
                            mensaje.innerHTML = `
                                                    <p style="color: green;">🎉 Pago completado por ${details.payer.name.given_name}.</p>
                                                    <p>Redirigiendo al catálogo...</p>
                                                `;

                            // Redirigir con parámetros
                            setTimeout(() => {
                                const params = new URLSearchParams({
                                    ventaID: ventaID,
                                    transaccionID: transaccionID,
                                    payer_name: details.payer.name.given_name
                                });

                                window.location.href = `graciasPaypal.html?${params.toString()}`;
                            }, 4000);

                        } catch (err) {
                            console.error("❌ Error al actualizar estado de la venta:", err);
                        }
                    });
                }
            }).render('#paypal-button-container');
        }
    </script>

    <script>
        async function pagarConMercadoPago(total) {
            console.log("Resultado de la venta:", ventaIDGlobal);
            try {
                const response = await fetch("https://api.mercadopago.com/checkout/preferences", {
                    method: "POST",
                    headers: {
                        "Authorization": "Bearer TEST-4900629034848231-092118-9d27675094644ae95ddaa4dde96235e7-55847519",
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        items: [
                            {
                                title: "Pedido RapiClean",
                                quantity: 1,
                                currency_id: "MXN",
                                unit_price: parseFloat(total)
                            }
                        ],
                        back_urls: {
                            success: "https://rapicleanpuebla.com/gracias.html",
                            failure: "https://rapicleanpuebla.com/error.html",
                            pending: "https://rapicleanpuebla.com/pending.html"
                        },
                        external_reference: ventaIDGlobal,  // ✅ Este campo es el correcto
                        auto_return: "approved"
                    })
                });

                const json = await response.json();

                if (json.init_point) {
                    console.log("✅ Preferencia generada:", json);
                    window.open(json.init_point, "_blank"); // Abre el checkout en nueva pestaña
                } else {
                    console.error("❌ Error en respuesta:", json);
                    alert("Hubo un problema al iniciar el pago con Mercado Pago.");
                }

            } catch (error) {
                console.error("❌ Error al generar preferencia:", error);
                alert("Error al conectar con Mercado Pago.");
            }
        }
    </script>

    <!-- 9. Footer-->
    <footer>
        <div class="social-links">
            <a href="https://www.facebook.com/rapicleanpuebla"><i class="fab fa-facebook"></i></a>
            <a href="https://www.instagram.com/rapicleanpuebla/"><i class="fab fa-instagram"></i></a>
        </div>
        <p>© 2025 Todos los derechos reservados</p>
    </footer>

    <div class="float-buttons">
        <a href="#" class="back-to-top" title="Volver al inicio">
            <i class="fas fa-arrow-up"></i>
        </a>

        <a href="https://wa.me/5212211276404" class="whatsapp-btn" target="_blank" title="Contactar por WhatsApp">
            <i class="fab fa-whatsapp"></i>
        </a>
    </div>
    <script src="assets/js/PaginaWeb.js"></script>
</body>

</html>